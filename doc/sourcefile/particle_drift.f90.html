<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
    <meta name="description" content="Documentation for Fortran Program">
	 
    <meta name="author" content="Chris MacMackin" >
    <link rel="icon" href="../favicon.png">

    <title>particle_drift.f90 &ndash; Fortran Program</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Fortran Program </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
                
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
				
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
								
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            <li><a href="../lists/programs.html">Programs</a></li>
				
          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>particle_drift.f90
    <small>Source File</small>
    
    </h1>
	 
<div class="row">
<div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
    <li><i class="fa fa-code"></i><a href="../src/particle_drift.f90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">particle_drift.f90</li>
  </ol>
</div>
</div>
</div>
    
  </div>
  <div class="row">
    <div class="col-lg-3">
    
<div id="sidebar">
  
  
  
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods">Modules</a></h3></div>
    <div id="mods" class="panel-collapse collapse">
        <div class="list-group">
          
          <a class="list-group-item" href="../module/particle_drift.html">particle_drift</a>
          
        </div>
    </div>
  </div>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
    <div class="list-group">
      <a class="list-group-item" href="../sourcefile/particle_drift.f90.html#src">particle_drift.f90</a>
    </div>
  </div>
  
  <hr>
  
  <div class="panel panel-default">
    <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles">All Source Files</a></h3></div>
    <div id="allfiles" class="panel-collapse collapse">
        <div class="list-group">
          
          <a class="list-group-item" href="../sourcefile/analysis_config.f90.html">analysis_config.f90</a>
          
          <a class="list-group-item" href="../sourcefile/bulk_internal_energy.f90.html">bulk_internal_energy.f90</a>
          
          <a class="list-group-item" href="../sourcefile/calc_agyrotropy.f90.html">calc_agyrotropy.f90</a>
          
          <a class="list-group-item" href="../sourcefile/cla_test.f90.html">cla_test.f90</a>
          
          <a class="list-group-item" href="../sourcefile/commandline_arguments.f90.html">commandline_arguments.f90</a>
          
          <a class="list-group-item" href="../sourcefile/compression.f90.html">compression.f90</a>
          
          <a class="list-group-item" href="../sourcefile/compression_shear.f90.html">compression_shear.f90</a>
          
          <a class="list-group-item" href="../sourcefile/current_densities.f90.html">current_densities.f90</a>
          
          <a class="list-group-item" href="../sourcefile/dissipation.f90.html">dissipation.f90</a>
          
          <a class="list-group-item" href="../sourcefile/electric_field.f90.html">electric_field.f90</a>
          
          <a class="list-group-item" href="../sourcefile/emfields.f90.html">emfields.f90</a>
          
          <a class="list-group-item" href="../sourcefile/fieldline_tracing.f90.html">fieldline_tracing.f90</a>
          
          <a class="list-group-item" href="../sourcefile/file_header.f90.html">file_header.f90</a>
          
          <a class="list-group-item" href="../sourcefile/get_info.f90.html">get_info.f90</a>
          
          <a class="list-group-item" href="../sourcefile/get_info_translate.f90.html">get_info_translate.f90</a>
          
          <a class="list-group-item" href="../sourcefile/inductive_efield.f90.html">inductive_efield.f90</a>
          
          <a class="list-group-item" href="../sourcefile/interpolation_emf.f90.html">interpolation_emf.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jdote_eband.f90.html">jdote_eband.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jdote_energy_band.f90.html">jdote_energy_band.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jdote_module.f90.html">jdote_module.f90</a>
          
          <a class="list-group-item" href="../sourcefile/kinds.f90.html">kinds.f90</a>
          
          <a class="list-group-item" href="../sourcefile/magnetic_field.f90.html">magnetic_field.f90</a>
          
          <a class="list-group-item" href="../sourcefile/maximum_energy.f90.html">maximum_energy.f90</a>
          
          <a class="list-group-item" href="../sourcefile/mpi_io_fields.f90.html">mpi_io_fields.f90</a>
          
          <a class="list-group-item" href="../sourcefile/mpi_io_translate.f90.html">mpi_io_translate.f90</a>
          
          <a class="list-group-item" href="../sourcefile/mpi_setup.f90.html">mpi_setup.f90</a>
          
          <a class="list-group-item" href="../sourcefile/neighbors.f90.html">neighbors.f90</a>
          
          <a class="list-group-item" href="../sourcefile/para_perp_pressure.f90.html">para_perp_pressure.f90</a>
          
          <a class="list-group-item" href="../sourcefile/parallel_hdf5.f90.html">parallel_hdf5.f90</a>
          
          <a class="list-group-item" href="../sourcefile/parallel_hdf5.f90%7E2.html">parallel_hdf5.f90</a>
          
          <a class="list-group-item" href="../sourcefile/parallel_potential.f90.html">parallel_potential.f90</a>
          
          <a class="list-group-item" href="../sourcefile/parameters.f90.html">parameters.f90</a>
          
          <a class="list-group-item" href="../sourcefile/parspec.f90.html">parspec.f90</a>
          
          <a class="list-group-item" href="../sourcefile/parspec_cpu_based.f90.html">parspec_cpu_based.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_based_jdote.f90.html">particle_based_jdote.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_drift.f90.html">particle_drift.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_fieldline.f90.html">particle_fieldline.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_fields.f90.html">particle_fields.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_file.f90.html">particle_file.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_frames.f90.html">particle_frames.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_info.f90.html">particle_info.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_module.f90.html">particle_module.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_number_eband.f90.html">particle_number_eband.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_spectrum.f90.html">particle_spectrum.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_spectrum_box.f90.html">particle_spectrum_box.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_spectrum_vdist.f90.html">particle_spectrum_vdist.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_spectrum_vdist_box.f90.html">particle_spectrum_vdist_box.f90</a>
          
          <a class="list-group-item" href="../sourcefile/particle_spectrum_vdist_python.f90.html">particle_spectrum_vdist_python.f90</a>
          
          <a class="list-group-item" href="../sourcefile/path_info.f90.html">path_info.f90</a>
          
          <a class="list-group-item" href="../sourcefile/pressure_tensor.f90.html">pressure_tensor.f90</a>
          
          <a class="list-group-item" href="../sourcefile/read_config.f90.html">read_config.f90</a>
          
          <a class="list-group-item" href="../sourcefile/saving_flags.f90.html">saving_flags.f90</a>
          
          <a class="list-group-item" href="../sourcefile/spectrum_along_fieldline.f90.html">spectrum_along_fieldline.f90</a>
          
          <a class="list-group-item" href="../sourcefile/spectrum_config.f90.html">spectrum_config.f90</a>
          
          <a class="list-group-item" href="../sourcefile/statistics.f90.html">statistics.f90</a>
          
          <a class="list-group-item" href="../sourcefile/topology_translate.f90.html">topology_translate.f90</a>
          
          <a class="list-group-item" href="../sourcefile/translate.f90.html">translate.f90</a>
          
          <a class="list-group-item" href="../sourcefile/translate_config.f90.html">translate_config.f90</a>
          
          <a class="list-group-item" href="../sourcefile/vdist.f90.html">vdist.f90</a>
          
          <a class="list-group-item" href="../sourcefile/vdist_1d_along_fieldline.f90.html">vdist_1d_along_fieldline.f90</a>
          
          <a class="list-group-item" href="../sourcefile/vdist_2d_along_fieldline.f90.html">vdist_2d_along_fieldline.f90</a>
          
          <a class="list-group-item" href="../sourcefile/vdistribution.f90.html">vdistribution.f90</a>
          
        </div>
    </div>
  </div>
  
</div>

    </div>
    <div class="col-lg-9" id='text'>
    <hr>
<p>Module of particle drift. This module will calculate particle curvature drift
 and gradient drift associated particle energy change. This module will also
 calculate the parallel acceleration. Note the particles are grouped into
 different energy band.</p>
<hr>
    <br>
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><a name="ln-1"></a><span class="c">!*******************************************************************************</span>
<a name="ln-2"></a><span class="c">! Module of particle drift. This module will calculate particle curvature drift</span>
<a name="ln-3"></a><span class="c">! and gradient drift associated particle energy change. This module will also</span>
<a name="ln-4"></a><span class="c">! calculate the parallel acceleration. Note the particles are grouped into</span>
<a name="ln-5"></a><span class="c">! different energy band.</span>
<a name="ln-6"></a><span class="c">!*******************************************************************************</span>
<a name="ln-7"></a><span class="k">module </span><span class="nv">particle_drift</span>
<a name="ln-8"></a>    <span class="k">use </span><span class="nv">constants</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">fp</span><span class="p">,</span> <span class="nv">dp</span>
<a name="ln-9"></a>    <span class="k">use </span><span class="nv">picinfo</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">domain</span> 
<a name="ln-10"></a>    <span class="k">use </span><span class="nv">path_info</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">rootpath</span>
<a name="ln-11"></a>    <span class="k">use </span><span class="nv">interpolation_emf</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">bx0</span><span class="p">,</span> <span class="nv">by0</span><span class="p">,</span> <span class="nv">bz0</span><span class="p">,</span> <span class="nv">ex0</span><span class="p">,</span> <span class="nv">ey0</span><span class="p">,</span> <span class="nv">ez0</span><span class="p">,</span> <span class="nv">bxn</span><span class="p">,</span> <span class="nv">byn</span><span class="p">,</span> <span class="nv">bzn</span>
<a name="ln-12"></a>    <span class="k">use </span><span class="nv">mpi_module</span>
<a name="ln-13"></a>    <span class="k">implicit none</span>
<a name="ln-14"></a><span class="k">    private</span>
<a name="ln-15"></a><span class="k">    public </span><span class="nv">init_drift_fields</span><span class="p">,</span> <span class="nv">init_para_perp_fields</span><span class="p">,</span> <span class="nv">init_jdote_sum</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-16"></a>           <span class="nv">set_drift_fields_zero</span><span class="p">,</span> <span class="nv">set_para_perp_fields_zero</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-17"></a>           <span class="nv">free_drift_fields</span><span class="p">,</span> <span class="nv">free_para_perp_fields</span><span class="p">,</span> <span class="nv">free_jdote_sum</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-18"></a>           <span class="nv">calc_particle_energy_change_rate</span><span class="p">,</span> <span class="nv">save_data_arrays</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-19"></a>           <span class="nv">sum_data_arrays</span><span class="p">,</span> <span class="nv">save_jdote_sum</span>
<a name="ln-20"></a>
<a name="ln-21"></a>    <span class="kt">real</span><span class="p">(</span><span class="nv">fp</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="kd">::</span> <span class="nv">jcpara_dote</span><span class="p">,</span> <span class="nv">jgrad_dote</span>
<a name="ln-22"></a>    <span class="kt">real</span><span class="p">(</span><span class="nv">fp</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="kd">::</span> <span class="nv">jpara_dote</span><span class="p">,</span> <span class="nv">jperp_dote</span>
<a name="ln-23"></a>    <span class="kt">real</span><span class="p">(</span><span class="nv">fp</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="kd">::</span> <span class="nv">jdote_sum_local</span><span class="p">,</span> <span class="nv">jdote_sum_global</span>
<a name="ln-24"></a>    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="nv">nvar</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c">! kinds of fieldsk</span>
<a name="ln-25"></a>    <span class="kt">real</span><span class="p">(</span><span class="nv">fp</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">gyrof</span>  <span class="c">! Gyro frequency</span>
<a name="ln-26"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">nx</span><span class="p">,</span> <span class="nv">ny</span><span class="p">,</span> <span class="nv">nz</span><span class="p">,</span> <span class="nv">nband</span>
<a name="ln-27"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ntp</span>  <span class="c">! Number of particle output frames.</span>
<a name="ln-28"></a>
<a name="ln-29"></a>    <span class="k">contains</span>
<a name="ln-30"></a>
<a name="ln-31"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-32"></a>    <span class="c">! Initialize the fields due to particle drift motions</span>
<a name="ln-33"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-34"></a>    <span class="k">subroutine </span><span class="nv">init_drift_fields</span>
<a name="ln-35"></a>        <span class="k">use </span><span class="nv">topology_translate</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">ht</span>
<a name="ln-36"></a>        <span class="k">use </span><span class="nv">picinfo</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">nbands</span>
<a name="ln-37"></a>        <span class="k">implicit none</span>
<a name="ln-38"></a><span class="k">        </span><span class="nv">nx</span> <span class="o">=</span> <span class="nv">ht</span><span class="p">%</span><span class="nv">nx</span>
<a name="ln-39"></a>        <span class="nv">ny</span> <span class="o">=</span> <span class="nv">ht</span><span class="p">%</span><span class="nv">ny</span>
<a name="ln-40"></a>        <span class="nv">nz</span> <span class="o">=</span> <span class="nv">ht</span><span class="p">%</span><span class="nv">nz</span>
<a name="ln-41"></a>        <span class="nv">nband</span> <span class="o">=</span> <span class="nv">nbands</span>
<a name="ln-42"></a>        <span class="k">allocate</span><span class="p">(</span><span class="nv">jcpara_dote</span><span class="p">(</span><span class="nv">nx</span><span class="p">,</span> <span class="nv">ny</span><span class="p">,</span> <span class="nv">nz</span><span class="p">,</span> <span class="nv">nband</span><span class="p">))</span>
<a name="ln-43"></a>        <span class="k">allocate</span><span class="p">(</span><span class="nv">jgrad_dote</span><span class="p">(</span><span class="nv">nx</span><span class="p">,</span> <span class="nv">ny</span><span class="p">,</span> <span class="nv">nz</span><span class="p">,</span> <span class="nv">nband</span><span class="p">))</span>
<a name="ln-44"></a>        <span class="k">call </span><span class="nv">set_drift_fields_zero</span>
<a name="ln-45"></a>    <span class="k">end subroutine </span><span class="nv">init_drift_fields</span>
<a name="ln-46"></a>
<a name="ln-47"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-48"></a>    <span class="c">! Set drift fields to be zero</span>
<a name="ln-49"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-50"></a>    <span class="k">subroutine </span><span class="nv">set_drift_fields_zero</span>
<a name="ln-51"></a>        <span class="k">implicit none</span>
<a name="ln-52"></a><span class="k">        </span><span class="nv">jcpara_dote</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-53"></a>        <span class="nv">jgrad_dote</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-54"></a>    <span class="k">end subroutine </span><span class="nv">set_drift_fields_zero</span>
<a name="ln-55"></a>
<a name="ln-56"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-57"></a>    <span class="c">! Initialize the fields due to particle parallel and perpendicular motions</span>
<a name="ln-58"></a>    <span class="c">! with respect to the local magnetic field.</span>
<a name="ln-59"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-60"></a>    <span class="k">subroutine </span><span class="nv">init_para_perp_fields</span>
<a name="ln-61"></a>        <span class="k">use </span><span class="nv">topology_translate</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">ht</span>
<a name="ln-62"></a>        <span class="k">use </span><span class="nv">picinfo</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">nbands</span>
<a name="ln-63"></a>        <span class="k">implicit none</span>
<a name="ln-64"></a><span class="k">        </span><span class="nv">nx</span> <span class="o">=</span> <span class="nv">ht</span><span class="p">%</span><span class="nv">nx</span>
<a name="ln-65"></a>        <span class="nv">ny</span> <span class="o">=</span> <span class="nv">ht</span><span class="p">%</span><span class="nv">ny</span>
<a name="ln-66"></a>        <span class="nv">nz</span> <span class="o">=</span> <span class="nv">ht</span><span class="p">%</span><span class="nv">nz</span>
<a name="ln-67"></a>        <span class="nv">nband</span> <span class="o">=</span> <span class="nv">nbands</span>
<a name="ln-68"></a>        <span class="k">allocate</span><span class="p">(</span><span class="nv">jpara_dote</span><span class="p">(</span><span class="nv">nx</span><span class="p">,</span> <span class="nv">ny</span><span class="p">,</span> <span class="nv">nz</span><span class="p">,</span> <span class="nv">nband</span><span class="p">))</span>
<a name="ln-69"></a>        <span class="k">allocate</span><span class="p">(</span><span class="nv">jperp_dote</span><span class="p">(</span><span class="nv">nx</span><span class="p">,</span> <span class="nv">ny</span><span class="p">,</span> <span class="nv">nz</span><span class="p">,</span> <span class="nv">nband</span><span class="p">))</span>
<a name="ln-70"></a>        <span class="k">call </span><span class="nv">set_para_perp_fields_zero</span>
<a name="ln-71"></a>    <span class="k">end subroutine </span><span class="nv">init_para_perp_fields</span>
<a name="ln-72"></a>
<a name="ln-73"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-74"></a>    <span class="c">! Set parallel and perpendicular fields to be zero</span>
<a name="ln-75"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-76"></a>    <span class="k">subroutine </span><span class="nv">set_para_perp_fields_zero</span>
<a name="ln-77"></a>        <span class="k">implicit none</span>
<a name="ln-78"></a><span class="k">        </span><span class="nv">jpara_dote</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-79"></a>        <span class="nv">jperp_dote</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-80"></a>    <span class="k">end subroutine </span><span class="nv">set_para_perp_fields_zero</span>
<a name="ln-81"></a>
<a name="ln-82"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-83"></a>    <span class="c">! Initialize the summation of the calculated jdote over the whole box.</span>
<a name="ln-84"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-85"></a>    <span class="k">subroutine </span><span class="nv">init_jdote_sum</span>
<a name="ln-86"></a>        <span class="k">use </span><span class="nv">picinfo</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">nbands</span><span class="p">,</span> <span class="nv">nt</span><span class="p">,</span> <span class="nv">domain</span>
<a name="ln-87"></a>        <span class="k">implicit none</span>
<a name="ln-88"></a><span class="k">        </span><span class="nv">ntp</span> <span class="o">=</span> <span class="p">(</span><span class="nv">nt</span> <span class="o">*</span> <span class="nv">domain</span><span class="p">%</span><span class="nv">fields_interval</span><span class="p">)</span> <span class="o">/</span> <span class="nv">domain</span><span class="p">%</span><span class="nv">particle_interval</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-89"></a>        <span class="k">allocate</span><span class="p">(</span><span class="nv">jdote_sum_local</span><span class="p">(</span><span class="nv">ntp</span><span class="p">,</span> <span class="nv">nbands</span><span class="p">,</span> <span class="nv">nvar</span><span class="p">))</span>
<a name="ln-90"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">myid</span> <span class="o">==</span> <span class="nv">master</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-91"></a><span class="k">            allocate</span><span class="p">(</span><span class="nv">jdote_sum_global</span><span class="p">(</span><span class="nv">ntp</span><span class="p">,</span> <span class="nv">nbands</span><span class="p">,</span> <span class="nv">nvar</span><span class="p">))</span>
<a name="ln-92"></a>            <span class="nv">jdote_sum_global</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-93"></a>        <span class="k">endif</span>
<a name="ln-94"></a><span class="k">        </span><span class="nv">jdote_sum_local</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-95"></a>    <span class="k">end subroutine </span><span class="nv">init_jdote_sum</span>
<a name="ln-96"></a>
<a name="ln-97"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-98"></a>    <span class="c">! Free the fields due to particle drift motions</span>
<a name="ln-99"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-100"></a>    <span class="k">subroutine </span><span class="nv">free_drift_fields</span>
<a name="ln-101"></a>        <span class="k">implicit none</span>
<a name="ln-102"></a><span class="k">        deallocate</span><span class="p">(</span><span class="nv">jcpara_dote</span><span class="p">,</span> <span class="nv">jgrad_dote</span><span class="p">)</span>
<a name="ln-103"></a>    <span class="k">end subroutine </span><span class="nv">free_drift_fields</span>
<a name="ln-104"></a>
<a name="ln-105"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-106"></a>    <span class="c">! Free the fields due to particle drift motions</span>
<a name="ln-107"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-108"></a>    <span class="k">subroutine </span><span class="nv">free_para_perp_fields</span>
<a name="ln-109"></a>        <span class="k">implicit none</span>
<a name="ln-110"></a><span class="k">        deallocate</span><span class="p">(</span><span class="nv">jpara_dote</span><span class="p">,</span> <span class="nv">jperp_dote</span><span class="p">)</span>
<a name="ln-111"></a>    <span class="k">end subroutine </span><span class="nv">free_para_perp_fields</span>
<a name="ln-112"></a>
<a name="ln-113"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-114"></a>    <span class="c">! Free the summation of the calculated jdote over the whole box.</span>
<a name="ln-115"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-116"></a>    <span class="k">subroutine </span><span class="nv">free_jdote_sum</span>
<a name="ln-117"></a>        <span class="k">implicit none</span>
<a name="ln-118"></a><span class="k">        deallocate</span><span class="p">(</span><span class="nv">jdote_sum_local</span><span class="p">)</span>
<a name="ln-119"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">myid</span> <span class="o">==</span> <span class="nv">master</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-120"></a><span class="k">            deallocate</span><span class="p">(</span><span class="nv">jdote_sum_global</span><span class="p">)</span>
<a name="ln-121"></a>        <span class="k">endif</span>
<a name="ln-122"></a><span class="k">    end subroutine </span><span class="nv">free_jdote_sum</span>
<a name="ln-123"></a>
<a name="ln-124"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-125"></a>    <span class="c">! Calculate the particle energy change rate of all the particles in one</span>
<a name="ln-126"></a>    <span class="c">! VPIC simulation MPI process.</span>
<a name="ln-127"></a>    <span class="c">! Input:</span>
<a name="ln-128"></a>    <span class="c">!   tindex: the time index, indicating the time step numbers in PIC simulation.</span>
<a name="ln-129"></a>    <span class="c">!   species: &#39;e&#39; for electron. &#39;h&#39; for others.</span>
<a name="ln-130"></a>    <span class="c">!   np: the VPIC simulation MPI process.</span>
<a name="ln-131"></a>    <span class="c">!   sx, sy, sz: the offset from the starting cell of current MPI process.</span>
<a name="ln-132"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-133"></a>    <span class="k">subroutine </span><span class="nv">calc_particle_energy_change_rate</span><span class="p">(</span><span class="nv">tindex</span><span class="p">,</span> <span class="nv">species</span><span class="p">,</span> <span class="nv">np</span><span class="p">,</span> <span class="nv">sx</span><span class="p">,</span> <span class="nv">sy</span><span class="p">,</span> <span class="nv">sz</span><span class="p">)</span>
<a name="ln-134"></a>        <span class="k">use </span><span class="nv">particle_file</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">open_particle_file</span><span class="p">,</span> <span class="nv">close_particle_file</span><span class="p">,</span> <span class="nv">fh</span>
<a name="ln-135"></a>        <span class="k">use </span><span class="nv">particle_module</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">ptl</span><span class="p">,</span> <span class="nv">calc_particle_energy</span><span class="p">,</span> <span class="nv">calc_interp_param</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-136"></a>                <span class="nv">calc_para_perp_velocity_3d</span><span class="p">,</span> <span class="nv">calc_gyrofrequency</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-137"></a>                <span class="nv">calc_gradient_drift_velocity</span><span class="p">,</span> <span class="nv">calc_curvature_drift_velocity</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-138"></a>                <span class="nv">iex</span><span class="p">,</span> <span class="nv">jex</span><span class="p">,</span> <span class="nv">kex</span><span class="p">,</span> <span class="nv">iey</span><span class="p">,</span> <span class="nv">jey</span><span class="p">,</span> <span class="nv">key</span><span class="p">,</span> <span class="nv">iez</span><span class="p">,</span> <span class="nv">jez</span><span class="p">,</span> <span class="nv">kez</span><span class="p">,</span> <span class="nv">ibx</span><span class="p">,</span> <span class="nv">jbx</span><span class="p">,</span> <span class="nv">kbx</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-139"></a>                <span class="nv">iby</span><span class="p">,</span> <span class="nv">jby</span><span class="p">,</span> <span class="nv">kby</span><span class="p">,</span> <span class="nv">ibz</span><span class="p">,</span> <span class="nv">jbz</span><span class="p">,</span> <span class="nv">kbz</span><span class="p">,</span> <span class="nv">dx_ex</span><span class="p">,</span> <span class="nv">dy_ex</span><span class="p">,</span> <span class="nv">dz_ex</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-140"></a>                <span class="nv">dx_ey</span><span class="p">,</span> <span class="nv">dy_ey</span><span class="p">,</span> <span class="nv">dz_ey</span><span class="p">,</span> <span class="nv">dx_ez</span><span class="p">,</span> <span class="nv">dy_ez</span><span class="p">,</span> <span class="nv">dz_ez</span><span class="p">,</span> <span class="nv">dx_bx</span><span class="p">,</span> <span class="nv">dx_by</span><span class="p">,</span> <span class="nv">dx_bz</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-141"></a>                <span class="nv">dy_bx</span><span class="p">,</span> <span class="nv">dy_by</span><span class="p">,</span> <span class="nv">dy_bz</span><span class="p">,</span> <span class="nv">dz_bx</span><span class="p">,</span> <span class="nv">dz_by</span><span class="p">,</span> <span class="nv">dz_bz</span>
<a name="ln-142"></a>        <span class="k">use </span><span class="nv">interpolation_emf</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">trilinear_interp_bx</span><span class="p">,</span> <span class="nv">trilinear_interp_by</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-143"></a>                <span class="nv">trilinear_interp_bz</span><span class="p">,</span> <span class="nv">trilinear_interp_ex</span><span class="p">,</span> <span class="nv">trilinear_interp_ey</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-144"></a>                <span class="nv">trilinear_interp_ez</span><span class="p">,</span> <span class="nv">calc_b_norm</span><span class="p">,</span> <span class="nv">calc_gradient_B</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-145"></a>                <span class="nv">calc_curvature</span>
<a name="ln-146"></a>        <span class="k">use </span><span class="nv">file_header</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">pheader</span>
<a name="ln-147"></a>        <span class="k">implicit none</span>
<a name="ln-148"></a><span class="k">        </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">species</span>
<a name="ln-149"></a>        <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">tindex</span><span class="p">,</span> <span class="nv">np</span><span class="p">,</span> <span class="nv">sx</span><span class="p">,</span> <span class="nv">sy</span><span class="p">,</span> <span class="nv">sz</span>
<a name="ln-150"></a>        <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">cid</span>
<a name="ln-151"></a>        <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">iptl</span>
<a name="ln-152"></a>
<a name="ln-153"></a>        <span class="k">write</span><span class="p">(</span><span class="nv">cid</span><span class="p">,</span> <span class="s2">&quot;(I0)&quot;</span><span class="p">)</span> <span class="nv">np</span>
<a name="ln-154"></a>        <span class="k">call </span><span class="nv">open_particle_file</span><span class="p">(</span><span class="nv">tindex</span><span class="p">,</span> <span class="nv">species</span><span class="p">,</span> <span class="nv">cid</span><span class="p">)</span>
<a name="ln-155"></a>        <span class="c">! Loop over particles</span>
<a name="ln-156"></a>        <span class="k">do </span><span class="nv">iptl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">pheader</span><span class="p">%</span><span class="nb">dim</span><span class="p">,</span> <span class="mi">1</span>
<a name="ln-157"></a>            <span class="k">read</span><span class="p">(</span><span class="nv">fh</span><span class="p">)</span> <span class="nv">ptl</span>
<a name="ln-158"></a>            <span class="k">call </span><span class="nv">calc_particle_energy</span>
<a name="ln-159"></a>            <span class="k">call </span><span class="nv">calc_interp_param</span>
<a name="ln-160"></a>            <span class="k">call </span><span class="nv">trilinear_interp_bx</span><span class="p">(</span><span class="nv">ibx</span><span class="p">,</span> <span class="nv">jbx</span><span class="p">,</span> <span class="nv">kbx</span><span class="p">,</span> <span class="nv">dx_bx</span><span class="p">,</span> <span class="nv">dy_bx</span><span class="p">,</span> <span class="nv">dz_bx</span><span class="p">)</span>
<a name="ln-161"></a>            <span class="k">call </span><span class="nv">trilinear_interp_by</span><span class="p">(</span><span class="nv">iby</span><span class="p">,</span> <span class="nv">jby</span><span class="p">,</span> <span class="nv">kby</span><span class="p">,</span> <span class="nv">dx_by</span><span class="p">,</span> <span class="nv">dy_by</span><span class="p">,</span> <span class="nv">dz_by</span><span class="p">)</span>
<a name="ln-162"></a>            <span class="k">call </span><span class="nv">trilinear_interp_bz</span><span class="p">(</span><span class="nv">ibz</span><span class="p">,</span> <span class="nv">jbz</span><span class="p">,</span> <span class="nv">kbz</span><span class="p">,</span> <span class="nv">dx_bz</span><span class="p">,</span> <span class="nv">dy_bz</span><span class="p">,</span> <span class="nv">dz_bz</span><span class="p">)</span>
<a name="ln-163"></a>            <span class="k">call </span><span class="nv">trilinear_interp_ex</span><span class="p">(</span><span class="nv">iex</span><span class="p">,</span> <span class="nv">jex</span><span class="p">,</span> <span class="nv">kex</span><span class="p">,</span> <span class="nv">dx_ex</span><span class="p">,</span> <span class="nv">dy_ex</span><span class="p">,</span> <span class="nv">dz_ex</span><span class="p">)</span>
<a name="ln-164"></a>            <span class="k">call </span><span class="nv">trilinear_interp_ey</span><span class="p">(</span><span class="nv">iey</span><span class="p">,</span> <span class="nv">jey</span><span class="p">,</span> <span class="nv">key</span><span class="p">,</span> <span class="nv">dx_ey</span><span class="p">,</span> <span class="nv">dy_ey</span><span class="p">,</span> <span class="nv">dz_ey</span><span class="p">)</span>
<a name="ln-165"></a>            <span class="k">call </span><span class="nv">trilinear_interp_ez</span><span class="p">(</span><span class="nv">iez</span><span class="p">,</span> <span class="nv">jez</span><span class="p">,</span> <span class="nv">kez</span><span class="p">,</span> <span class="nv">dx_ez</span><span class="p">,</span> <span class="nv">dy_ez</span><span class="p">,</span> <span class="nv">dz_ez</span><span class="p">)</span>
<a name="ln-166"></a>            <span class="k">call </span><span class="nv">calc_b_norm</span>
<a name="ln-167"></a>            <span class="k">call </span><span class="nv">calc_gradient_B</span>
<a name="ln-168"></a>            <span class="k">call </span><span class="nv">calc_curvature</span>
<a name="ln-169"></a>            <span class="k">call </span><span class="nv">calc_para_perp_velocity_3d</span>
<a name="ln-170"></a>            <span class="k">call </span><span class="nv">calc_gyrofrequency</span>
<a name="ln-171"></a>            <span class="k">call </span><span class="nv">calc_gradient_drift_velocity</span>
<a name="ln-172"></a>            <span class="k">call </span><span class="nv">calc_curvature_drift_velocity</span>
<a name="ln-173"></a>            <span class="k">call </span><span class="nv">update_data_arrays</span><span class="p">(</span><span class="nv">sx</span><span class="p">,</span> <span class="nv">sy</span><span class="p">,</span> <span class="nv">sz</span><span class="p">)</span>
<a name="ln-174"></a>        <span class="nv">enddo</span>
<a name="ln-175"></a>        <span class="k">call </span><span class="nv">close_particle_file</span>
<a name="ln-176"></a>    <span class="k">end subroutine </span><span class="nv">calc_particle_energy_change_rate</span>
<a name="ln-177"></a>
<a name="ln-178"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-179"></a>    <span class="c">! Update the particle energy change rate arrays. jcpara_dote, jgrad_dote,</span>
<a name="ln-180"></a>    <span class="c">! jpara_dote, jperp_dote.</span>
<a name="ln-181"></a>    <span class="c">! Input:</span>
<a name="ln-182"></a>    <span class="c">!   sx, sy, sz: the offset from the starting cell of current MPI process.</span>
<a name="ln-183"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-184"></a>    <span class="k">subroutine </span><span class="nv">update_data_arrays</span><span class="p">(</span><span class="nv">sx</span><span class="p">,</span> <span class="nv">sy</span><span class="p">,</span> <span class="nv">sz</span><span class="p">)</span>
<a name="ln-185"></a>        <span class="k">use </span><span class="nv">particle_module</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">gama</span><span class="p">,</span> <span class="nv">igama</span><span class="p">,</span> <span class="nv">vparax</span><span class="p">,</span> <span class="nv">vparay</span><span class="p">,</span> <span class="nv">vparaz</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-186"></a>                <span class="nv">vperpx</span><span class="p">,</span> <span class="nv">vperpy</span><span class="p">,</span> <span class="nv">vperpz</span><span class="p">,</span> <span class="nv">gyrof</span><span class="p">,</span> <span class="nv">vgx</span><span class="p">,</span> <span class="nv">vgy</span><span class="p">,</span> <span class="nv">vgz</span><span class="p">,</span> <span class="nv">vcx</span><span class="p">,</span> <span class="nv">vcy</span><span class="p">,</span> <span class="nv">vcz</span>
<a name="ln-187"></a>        <span class="k">use </span><span class="nv">interpolation_emf</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">ex0</span><span class="p">,</span> <span class="nv">ey0</span><span class="p">,</span> <span class="nv">ez0</span>
<a name="ln-188"></a>        <span class="k">use </span><span class="nv">particle_info</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">ptl_charge</span><span class="p">,</span> <span class="nv">species</span>
<a name="ln-189"></a>        <span class="k">use </span><span class="nv">picinfo</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">einterval_e</span><span class="p">,</span> <span class="nv">einterval_i</span><span class="p">,</span> <span class="nv">nbands</span>
<a name="ln-190"></a>        <span class="k">use </span><span class="nv">particle_module</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">ci</span><span class="p">,</span> <span class="nv">cj</span><span class="p">,</span> <span class="nv">ck</span>
<a name="ln-191"></a>        <span class="k">implicit none</span>
<a name="ln-192"></a><span class="k">        </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">sx</span><span class="p">,</span> <span class="nv">sy</span><span class="p">,</span> <span class="nv">sz</span>
<a name="ln-193"></a>        <span class="kt">real</span><span class="p">(</span><span class="nv">fp</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">einterval</span>
<a name="ln-194"></a>        <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ibin</span><span class="p">,</span> <span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span>
<a name="ln-195"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">species</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-196"></a><span class="k">            </span><span class="nv">einterval</span> <span class="o">=</span> <span class="nv">einterval_e</span>
<a name="ln-197"></a>        <span class="k">else</span>
<a name="ln-198"></a><span class="k">            </span><span class="nv">einterval</span> <span class="o">=</span> <span class="nv">einterval_i</span>
<a name="ln-199"></a>        <span class="k">endif</span>
<a name="ln-200"></a><span class="k">        </span><span class="nv">ibin</span> <span class="o">=</span> <span class="p">(</span><span class="nv">gama</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nv">einterval</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-201"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">ibin</span> <span class="o">&gt;</span> <span class="nv">nbands</span><span class="p">)</span> <span class="nv">ibin</span> <span class="o">=</span> <span class="nv">nbands</span>
<a name="ln-202"></a>        <span class="nv">ix</span> <span class="o">=</span> <span class="nv">ci</span> <span class="o">+</span> <span class="nv">sx</span>
<a name="ln-203"></a>        <span class="nv">iy</span> <span class="o">=</span> <span class="nv">cj</span> <span class="o">+</span> <span class="nv">sy</span>
<a name="ln-204"></a>        <span class="nv">iz</span> <span class="o">=</span> <span class="nv">ck</span> <span class="o">+</span> <span class="nv">sz</span>
<a name="ln-205"></a>        <span class="nv">jcpara_dote</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span><span class="p">,</span> <span class="nv">ibin</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jcpara_dote</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span><span class="p">,</span> <span class="nv">ibin</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-206"></a>            <span class="nv">ptl_charge</span> <span class="o">*</span> <span class="p">(</span><span class="nv">vcx</span><span class="o">*</span><span class="nv">ex0</span> <span class="o">+</span> <span class="nv">vcy</span><span class="o">*</span><span class="nv">ey0</span> <span class="o">+</span> <span class="nv">vcz</span><span class="o">*</span><span class="nv">ez0</span><span class="p">)</span>
<a name="ln-207"></a>        <span class="nv">jgrad_dote</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span><span class="p">,</span> <span class="nv">ibin</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jgrad_dote</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span><span class="p">,</span> <span class="nv">ibin</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-208"></a>            <span class="nv">ptl_charge</span> <span class="o">*</span> <span class="p">(</span><span class="nv">vgx</span><span class="o">*</span><span class="nv">ex0</span> <span class="o">+</span> <span class="nv">vgy</span><span class="o">*</span><span class="nv">ey0</span> <span class="o">+</span> <span class="nv">vgz</span><span class="o">*</span><span class="nv">ez0</span><span class="p">)</span>
<a name="ln-209"></a>        <span class="nv">jpara_dote</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span><span class="p">,</span> <span class="nv">ibin</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jpara_dote</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span><span class="p">,</span> <span class="nv">ibin</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-210"></a>            <span class="nv">ptl_charge</span> <span class="o">*</span> <span class="p">(</span><span class="nv">vparax</span><span class="o">*</span><span class="nv">ex0</span> <span class="o">+</span> <span class="nv">vparay</span><span class="o">*</span><span class="nv">ey0</span> <span class="o">+</span> <span class="nv">vparaz</span><span class="o">*</span><span class="nv">ez0</span><span class="p">)</span>
<a name="ln-211"></a>        <span class="nv">jperp_dote</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span><span class="p">,</span> <span class="nv">ibin</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jperp_dote</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span><span class="p">,</span> <span class="nv">ibin</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-212"></a>            <span class="nv">ptl_charge</span> <span class="o">*</span> <span class="p">(</span><span class="nv">vperpx</span><span class="o">*</span><span class="nv">ex0</span> <span class="o">+</span> <span class="nv">vperpy</span><span class="o">*</span><span class="nv">ey0</span> <span class="o">+</span> <span class="nv">vperpz</span><span class="o">*</span><span class="nv">ez0</span><span class="p">)</span>
<a name="ln-213"></a>    <span class="k">end subroutine </span><span class="nv">update_data_arrays</span>
<a name="ln-214"></a>
<a name="ln-215"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-216"></a>    <span class="c">! Save the calculated data arrays.</span>
<a name="ln-217"></a>    <span class="c">! Input:</span>
<a name="ln-218"></a>    <span class="c">!   tindex: the time step index.</span>
<a name="ln-219"></a>    <span class="c">!   output_record: it decides the offset from the file head.</span>
<a name="ln-220"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-221"></a>    <span class="k">subroutine </span><span class="nv">save_data_arrays</span><span class="p">(</span><span class="nv">tindex</span><span class="p">,</span> <span class="nv">output_record</span><span class="p">)</span>
<a name="ln-222"></a>        <span class="k">use </span><span class="nv">path_info</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">opath</span> <span class="o">=&gt;</span> <span class="nv">outputpath</span>
<a name="ln-223"></a>        <span class="k">use </span><span class="nv">mpi_io_translate</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">write_data</span>
<a name="ln-224"></a>        <span class="k">use </span><span class="nv">picinfo</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">nbands</span>
<a name="ln-225"></a>        <span class="k">use </span><span class="nv">particle_info</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">species</span><span class="p">,</span> <span class="nv">ptl_charge</span>
<a name="ln-226"></a>        <span class="k">use </span><span class="nv">particle_fields</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">nrho</span><span class="p">,</span> <span class="nv">eb</span>
<a name="ln-227"></a>        <span class="k">implicit none</span>
<a name="ln-228"></a><span class="k">        </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">tindex</span><span class="p">,</span> <span class="nv">output_record</span>
<a name="ln-229"></a>        <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">fname</span>
<a name="ln-230"></a>        <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">band_tag</span>
<a name="ln-231"></a>        <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span> 
<a name="ln-232"></a>        <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ix</span><span class="p">,</span> <span class="nv">iy</span><span class="p">,</span> <span class="nv">iz</span>
<a name="ln-233"></a>
<a name="ln-234"></a>        <span class="c">! The original nrho is charge density.</span>
<a name="ln-235"></a>        <span class="nv">nrho</span> <span class="o">=</span> <span class="nv">nrho</span> <span class="o">/</span> <span class="nv">ptl_charge</span>
<a name="ln-236"></a>
<a name="ln-237"></a>        <span class="k">do </span><span class="nv">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">nbands</span>
<a name="ln-238"></a>            <span class="k">write</span><span class="p">(</span><span class="nv">band_tag</span><span class="p">,</span> <span class="s1">&#39;(I2.2)&#39;</span><span class="p">)</span> <span class="nv">i</span>
<a name="ln-239"></a>            <span class="k">where</span> <span class="p">(</span><span class="nv">eb</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="ln-240"></a>                <span class="nv">jcpara_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jcpara_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nv">nrho</span><span class="o">*</span><span class="nv">eb</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">))</span>
<a name="ln-241"></a>                <span class="nv">jgrad_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jgrad_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nv">nrho</span><span class="o">*</span><span class="nv">eb</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">))</span>
<a name="ln-242"></a>                <span class="nv">jpara_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jpara_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nv">nrho</span><span class="o">*</span><span class="nv">eb</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">))</span>
<a name="ln-243"></a>                <span class="nv">jperp_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jperp_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nv">nrho</span><span class="o">*</span><span class="nv">eb</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">))</span>
<a name="ln-244"></a>            <span class="nv">elsewhere</span>
<a name="ln-245"></a>                <span class="nv">jcpara_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-246"></a>                <span class="nv">jgrad_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-247"></a>                <span class="nv">jpara_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-248"></a>                <span class="nv">jperp_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-249"></a>            <span class="k">end where</span>
<a name="ln-250"></a>
<a name="ln-251"></a><span class="k">            </span><span class="nv">fname</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="nv">opath</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;jcpara_dote_&#39;</span><span class="o">//</span><span class="nv">species</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nv">band_tag</span>
<a name="ln-252"></a>            <span class="k">call </span><span class="nv">write_data</span><span class="p">(</span><span class="nv">fname</span><span class="p">,</span> <span class="nv">jcpara_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">),</span> <span class="nv">tindex</span><span class="p">,</span> <span class="nv">output_record</span><span class="p">)</span>
<a name="ln-253"></a>            <span class="nv">fname</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="nv">opath</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;jgrad_dote_&#39;</span><span class="o">//</span><span class="nv">species</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nv">band_tag</span>
<a name="ln-254"></a>            <span class="k">call </span><span class="nv">write_data</span><span class="p">(</span><span class="nv">fname</span><span class="p">,</span> <span class="nv">jgrad_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">),</span> <span class="nv">tindex</span><span class="p">,</span> <span class="nv">output_record</span><span class="p">)</span>
<a name="ln-255"></a>            <span class="nv">fname</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="nv">opath</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;jpara_dote_&#39;</span><span class="o">//</span><span class="nv">species</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nv">band_tag</span>
<a name="ln-256"></a>            <span class="k">call </span><span class="nv">write_data</span><span class="p">(</span><span class="nv">fname</span><span class="p">,</span> <span class="nv">jpara_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">),</span> <span class="nv">tindex</span><span class="p">,</span> <span class="nv">output_record</span><span class="p">)</span>
<a name="ln-257"></a>            <span class="nv">fname</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="nv">opath</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;jperp_dote_&#39;</span><span class="o">//</span><span class="nv">species</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nv">band_tag</span>
<a name="ln-258"></a>            <span class="k">call </span><span class="nv">write_data</span><span class="p">(</span><span class="nv">fname</span><span class="p">,</span> <span class="nv">jperp_dote</span><span class="p">(:,:,:,</span><span class="nv">i</span><span class="p">),</span> <span class="nv">tindex</span><span class="p">,</span> <span class="nv">output_record</span><span class="p">)</span>
<a name="ln-259"></a>        <span class="nv">enddo</span>
<a name="ln-260"></a>
<a name="ln-261"></a>    <span class="k">end subroutine </span><span class="nv">save_data_arrays</span>
<a name="ln-262"></a>
<a name="ln-263"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-264"></a>    <span class="c">! Sum the data arrays over the simulation box.</span>
<a name="ln-265"></a>    <span class="c">! Input:</span>
<a name="ln-266"></a>    <span class="c">!   ct: current time frame</span>
<a name="ln-267"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-268"></a>    <span class="k">subroutine </span><span class="nv">sum_data_arrays</span><span class="p">(</span><span class="nv">ct</span><span class="p">)</span>
<a name="ln-269"></a>        <span class="k">use </span><span class="nv">picinfo</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">nbands</span><span class="p">,</span> <span class="nv">domain</span>
<a name="ln-270"></a>        <span class="k">implicit none</span>
<a name="ln-271"></a><span class="k">        </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">ct</span>
<a name="ln-272"></a>        <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">iband</span>
<a name="ln-273"></a>        <span class="kt">real</span><span class="p">(</span><span class="nv">fp</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">dv</span>
<a name="ln-274"></a>        <span class="nv">dv</span> <span class="o">=</span> <span class="nv">domain</span><span class="p">%</span><span class="nv">dx</span> <span class="o">*</span> <span class="nv">domain</span><span class="p">%</span><span class="nv">dy</span> <span class="o">*</span> <span class="nv">domain</span><span class="p">%</span><span class="nv">dz</span>
<a name="ln-275"></a>        <span class="k">where</span> <span class="p">(</span><span class="nv">ISNAN</span><span class="p">(</span><span class="nv">jcpara_dote</span><span class="p">))</span>
<a name="ln-276"></a>            <span class="nv">jcpara_dote</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-277"></a>        <span class="k">end where</span>
<a name="ln-278"></a><span class="k">        where</span> <span class="p">(</span><span class="nv">ISNAN</span><span class="p">(</span><span class="nv">jgrad_dote</span><span class="p">))</span>
<a name="ln-279"></a>            <span class="nv">jgrad_dote</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-280"></a>        <span class="k">end where</span>
<a name="ln-281"></a><span class="k">        where</span> <span class="p">(</span><span class="nv">ISNAN</span><span class="p">(</span><span class="nv">jpara_dote</span><span class="p">))</span>
<a name="ln-282"></a>            <span class="nv">jpara_dote</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-283"></a>        <span class="k">end where</span>
<a name="ln-284"></a><span class="k">        where</span> <span class="p">(</span><span class="nv">ISNAN</span><span class="p">(</span><span class="nv">jperp_dote</span><span class="p">))</span>
<a name="ln-285"></a>            <span class="nv">jperp_dote</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-286"></a>        <span class="k">end where</span>
<a name="ln-287"></a><span class="k">        do </span><span class="nv">iband</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">nbands</span>
<a name="ln-288"></a>            <span class="nv">jdote_sum_local</span><span class="p">(</span><span class="nv">ct</span><span class="p">,</span> <span class="nv">iband</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nv">jcpara_dote</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="nv">iband</span><span class="p">))</span>
<a name="ln-289"></a>            <span class="nv">jdote_sum_local</span><span class="p">(</span><span class="nv">ct</span><span class="p">,</span> <span class="nv">iband</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nv">jgrad_dote</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="nv">iband</span><span class="p">))</span>
<a name="ln-290"></a>            <span class="nv">jdote_sum_local</span><span class="p">(</span><span class="nv">ct</span><span class="p">,</span> <span class="nv">iband</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nv">jpara_dote</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="nv">iband</span><span class="p">))</span>
<a name="ln-291"></a>            <span class="nv">jdote_sum_local</span><span class="p">(</span><span class="nv">ct</span><span class="p">,</span> <span class="nv">iband</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nv">jperp_dote</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="nv">iband</span><span class="p">))</span>
<a name="ln-292"></a>        <span class="nv">enddo</span>
<a name="ln-293"></a>    <span class="k">end subroutine </span><span class="nv">sum_data_arrays</span>
<a name="ln-294"></a>
<a name="ln-295"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-296"></a>    <span class="c">! Save the summed data</span>
<a name="ln-297"></a>    <span class="c">!---------------------------------------------------------------------------</span>
<a name="ln-298"></a>    <span class="k">subroutine </span><span class="nv">save_jdote_sum</span>
<a name="ln-299"></a>        <span class="k">use </span><span class="nv">particle_info</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">species</span>
<a name="ln-300"></a>        <span class="k">use </span><span class="nv">picinfo</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">nbands</span><span class="p">,</span> <span class="nv">nt</span>
<a name="ln-301"></a>        <span class="k">implicit none</span>
<a name="ln-302"></a><span class="k">        </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ct</span><span class="p">,</span> <span class="nv">fh</span>
<a name="ln-303"></a>        <span class="kt">logical</span> <span class="kd">::</span> <span class="nv">dir_e</span>
<a name="ln-304"></a>        <span class="k">call </span><span class="nv">MPI_REDUCE</span><span class="p">(</span><span class="nv">jdote_sum_local</span><span class="p">,</span> <span class="nv">jdote_sum_global</span><span class="p">,</span> <span class="nv">ntp</span><span class="o">*</span><span class="nv">nbands</span><span class="o">*</span><span class="nv">nvar</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-305"></a>                <span class="nv">MPI_REAL</span><span class="p">,</span> <span class="nv">MPI_SUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
<a name="ln-306"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">myid</span> <span class="o">==</span> <span class="nv">master</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-307"></a><span class="k">            inquire</span><span class="p">(</span><span class="nv">file</span><span class="o">=</span><span class="s1">&#39;./data/.&#39;</span><span class="p">,</span> <span class="nv">exist</span><span class="o">=</span><span class="nv">dir_e</span><span class="p">)</span>
<a name="ln-308"></a>            <span class="k">if</span> <span class="p">(</span><span class="ow">.not.</span> <span class="nv">dir_e</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-309"></a><span class="k">                call </span><span class="nb">system</span><span class="p">(</span><span class="s1">&#39;mkdir ./data&#39;</span><span class="p">)</span>
<a name="ln-310"></a>            <span class="k">endif</span>
<a name="ln-311"></a><span class="k">            print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Saving particle based drift analysis resutls...&quot;</span>
<a name="ln-312"></a>
<a name="ln-313"></a>            <span class="nv">fh</span> <span class="o">=</span> <span class="mi">61</span>
<a name="ln-314"></a>
<a name="ln-315"></a>            <span class="k">open</span><span class="p">(</span><span class="nv">unit</span><span class="o">=</span><span class="nv">fh</span><span class="p">,</span> <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;data/jcpara_dote_&#39;</span><span class="o">//</span><span class="nv">species</span><span class="o">//</span><span class="s1">&#39;_p.gda&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-316"></a>                <span class="nb">access</span><span class="o">=</span><span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="nv">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="nv">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-317"></a>                <span class="nv">action</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
<a name="ln-318"></a>            <span class="k">write</span><span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="nv">pos</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="nv">jdote_sum_global</span><span class="p">(:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-319"></a>            <span class="k">close</span><span class="p">(</span><span class="nv">fh</span><span class="p">)</span>
<a name="ln-320"></a>
<a name="ln-321"></a>            <span class="k">open</span><span class="p">(</span><span class="nv">unit</span><span class="o">=</span><span class="nv">fh</span><span class="p">,</span> <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;data/jgrad_dote_&#39;</span><span class="o">//</span><span class="nv">species</span><span class="o">//</span><span class="s1">&#39;_p.gda&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-322"></a>                <span class="nb">access</span><span class="o">=</span><span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="nv">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="nv">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-323"></a>                <span class="nv">action</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
<a name="ln-324"></a>            <span class="k">write</span><span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="nv">pos</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="nv">jdote_sum_global</span><span class="p">(:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-325"></a>            <span class="k">close</span><span class="p">(</span><span class="nv">fh</span><span class="p">)</span>
<a name="ln-326"></a>
<a name="ln-327"></a>            <span class="k">open</span><span class="p">(</span><span class="nv">unit</span><span class="o">=</span><span class="nv">fh</span><span class="p">,</span> <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;data/jpara_dote_&#39;</span><span class="o">//</span><span class="nv">species</span><span class="o">//</span><span class="s1">&#39;_p.gda&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-328"></a>                <span class="nb">access</span><span class="o">=</span><span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="nv">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="nv">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-329"></a>                <span class="nv">action</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
<a name="ln-330"></a>            <span class="k">write</span><span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="nv">pos</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="nv">jdote_sum_global</span><span class="p">(:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-331"></a>            <span class="k">close</span><span class="p">(</span><span class="nv">fh</span><span class="p">)</span>
<a name="ln-332"></a>
<a name="ln-333"></a>            <span class="k">open</span><span class="p">(</span><span class="nv">unit</span><span class="o">=</span><span class="nv">fh</span><span class="p">,</span> <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;data/jperp_dote_&#39;</span><span class="o">//</span><span class="nv">species</span><span class="o">//</span><span class="s1">&#39;_p.gda&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-334"></a>                <span class="nb">access</span><span class="o">=</span><span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="nv">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="nv">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-335"></a>                <span class="nv">action</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
<a name="ln-336"></a>            <span class="k">write</span><span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="nv">pos</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="nv">jdote_sum_global</span><span class="p">(:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-337"></a>            <span class="k">close</span><span class="p">(</span><span class="nv">fh</span><span class="p">)</span>
<a name="ln-338"></a>        <span class="k">endif</span>
<a name="ln-339"></a><span class="k">    end subroutine </span><span class="nv">save_jdote_sum</span>
<a name="ln-340"></a>
<a name="ln-341"></a><span class="k">end module </span><span class="nv">particle_drift</span>
</pre></div>

    </section>
    </div>
  </div>

    <hr>
    <footer>
        <div class="row">
        <div class="col-md-4">&copy; 2016 </div>
	<div class="col-md-4"><span class="text-center"> Fortran Program was developed by </span></div>
        <div class="col-md-4"><span class="pull-right">Documentation generated by <a href="https://github.com/cmacmackin/ford">FORD</a></span></div>
        </div>
        <br>
    </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>